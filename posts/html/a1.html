<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Markdown 转 HTML</title>
    <!-- 加载 MathJax -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js"></script>    
    
    <!-- 引入 Highlight.js 的样式 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">

    <!-- 引入外部样式 -->
    <link rel="stylesheet" href="../style.css">

    <!-- 引入 Highlight.js 的脚本 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
</head>
<body>
    <header>
        <h1>{markdown_file.stem}</h1>
    </header>
    <div id="html"></div>
    <footer>
        <p><a href="../index.html">回首頁</a></p>
    </footer>
    <!-- 通过 CDN 加载 marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // 配置 marked 使用 Highlight.js 进行代码高亮
        marked.setOptions({
            highlight: function(code, language) {
                const validLanguage = hljs.getLanguage(language) ? language : 'plaintext';
                return hljs.highlight(code, { language: validLanguage }).value;
            }
        });

        async function convert() {
            try {
                // 获取外部的 Markdown 文件内容
                const response = await fetch('a.md');
                if (!response.ok) {
                    throw new Error(`无法加载 Markdown 文件: ${response.statusText}`);
                }else{
                    const response = await fetch('a.md');
                    if (!response.ok) {
                        throw new Error(`无法加载 Markdown 文件: ${response.statusText}`);
                    }
                }
                
                let mdContent = await response.text();

                // 将 `$latex$` 转为 `\(latex\)` 和 `$$latex$$` 转为 `\[latex\]`
                mdContent = mdContent
                    .replace(/\$\$(.+?)\$\$/gs, (_, latex) => `\\[${latex}\\]`) // 转换 outline LaTeX
                    .replace(/\$(.+?)\$/g, (_, latex) => `\\(${latex}\\)`);     // 转换 inline LaTeX

                // 使用 marked.js 将 Markdown 转换为 HTML
                const htmlContent = marked.parse(mdContent);
                document.getElementById('html').innerHTML = htmlContent;

                // MathJax 重新处理新插入的内容
                if (window.MathJax) {
                    await MathJax.typesetPromise();
                    console.log("MathJax 渲染完成");
                }
            } catch (error) {
                console.error('转换过程中出错:', error);
                document.getElementById('html').innerHTML = `<p style="color:red;">加载内容失败: ${error.message}</p>`;
            }
        }
        // 页面加载完成后自动调用 convert()
        window.onload = convert;
    </script>
</body>
</html>
